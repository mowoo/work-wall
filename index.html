<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÈõ≤Á´ØÂ∑•‰ΩúÁâÜ (FirebaseÁâà)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #f5f5f7;
            --glass-bg: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --accent-green: #30d158;
            --card-bg: rgba(60, 60, 65, 0.7);
            
            /* ÊöóËâ≤Á≥ª‰∏ªÈ°åËâ≤ (ÂØ©Ê†∏ÂçÄ) */
            --dark-red-bg: rgba(60, 10, 10, 0.85);
            --dark-red-border: #5c1b1b;
            --dark-orange-bg: rgba(60, 35, 5, 0.85);
            --dark-orange-border: #633308;
            --dark-green-bg: rgba(10, 45, 15, 0.85);
            --dark-green-border: #144018;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, rgba(50, 50, 60, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(20, 20, 25, 0.5) 0px, transparent 50%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Toolbar --- */
        .toolbar {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; opacity: 0.9; }

        .connection-status {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #888;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff453a; /* Default red (offline) */
            transition: background-color 0.3s;
        }

        /* --- Board Area --- */
        .board {
            flex-grow: 1;
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        /* --- Columns --- */
        .column {
            flex: 0 0 320px;
            max-width: 320px;
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: transform 0.2s;
        }

        .column-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        
        #col-urgent { border-top: 3px solid var(--accent-red); }
        #col-urgent .column-header { color: var(--accent-red); background: linear-gradient(to bottom, rgba(255, 69, 58, 0.1), transparent); }

        #col-next-week { border-top: 3px solid var(--accent-orange); }
        #col-next-week .column-header { color: var(--accent-orange); background: linear-gradient(to bottom, rgba(255, 159, 10, 0.1), transparent); }

        #col-long-term { border-top: 3px solid var(--accent-green); }
        #col-long-term .column-header { color: var(--accent-green); background: linear-gradient(to bottom, rgba(48, 209, 88, 0.1), transparent); }

        .note-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 100px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }
        .note-list::-webkit-scrollbar { width: 6px; }
        .note-list::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); border-radius: 10px; }

        /* --- Review Zones --- */
        .review-zone {
            flex-shrink: 0;
            max-height: 35%;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.15);
            border-top: 1px dashed rgba(255, 255, 255, 0.15);
        }

        .review-header {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            padding: 6px 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .review-header::before { content: ''; display: block; width: 6px; height: 6px; border-radius: 50%; background-color: rgba(255,255,255,0.2); }

        .review-list { padding: 8px 12px; overflow-y: auto; min-height: 60px; scrollbar-width: thin; }

        /* --- Cards --- */
        .note {
            background-color: var(--card-bg);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: grab;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            animation: fadeIn 0.3s ease;
        }

        .note:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); border-color: rgba(255, 255, 255, 0.2); z-index: 10; }

        /* Review Zone Colors */
        #review-urgent .note { background-color: var(--dark-red-bg); border-color: var(--dark-red-border); color: #ffcccc; }
        #review-next .note { background-color: var(--dark-orange-bg); border-color: var(--dark-orange-border); color: #ffeeba; }
        #review-long .note { background-color: var(--dark-green-bg); border-color: var(--dark-green-border); color: #d1e7dd; }

        .review-list .note { font-size: 0.9rem; padding: 10px; opacity: 0.9; }
        .review-list .note:hover { opacity: 1; }

        .note:active { cursor: grabbing; }
        .note-content { outline: none; word-break: break-word; }

        .delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            font-size: 14px;
        }
        .note:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: rgba(255, 69, 58, 0.2); color: var(--accent-red); }
        .dragging { opacity: 0.4; transform: scale(0.95); }

        /* --- Footer --- */
        .list-footer {
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.25);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            flex-shrink: 0;
        }
        .add-card-wrapper { display: flex; gap: 8px; }
        .new-card-input {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 10px;
            color: white;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .new-card-input:focus { border-color: rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); }
        .mini-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); border-radius: 6px; cursor: pointer; padding: 0 10px; }
        .mini-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 600px) {
            .board { flex-direction: column; overflow-y: auto; }
            .column { flex: none; max-width: 100%; margin-bottom: 20px; max-height: none; }
            .review-zone { max-height: none; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div style="display:flex; align-items:center;">
            <h1>Èõ≤Á´ØÂ∑•‰ΩúÁâÜ</h1>
        </div>
        <div class="connection-status">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">ÈÄ£Êé•‰∏≠...</span>
        </div>
    </div>

    <div class="board">
        <div class="column" id="col-urgent">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-urgent">üî• Ê•µÈáçË¶Å / Êà™Á®øËøë</span></div>
            <div class="note-list" id="urgent-list"></div>
            <div class="review-zone">
                <div class="review-header">ÂØ©Ê†∏ / Êö´‰∏ÄÊÆµËêΩ</div>
                <div class="note-list review-list" id="review-urgent"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-urgent" placeholder="Êñ∞Â¢û‰∫ãÈ†Ö..." onkeypress="handleInputKey(event, 'urgent-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('urgent-list', 'input-urgent')">Ôºã</button>
                </div>
            </div>
        </div>

        <div class="column" id="col-next-week">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-next">üìÖ ‰∏ãÂë®ÈáçË¶Å‰∫ãÂãô</span></div>
            <div class="note-list" id="next-week-list"></div>
            <div class="review-zone">
                <div class="review-header">ÂØ©Ê†∏ / Êö´‰∏ÄÊÆµËêΩ</div>
                <div class="note-list review-list" id="review-next"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-next" placeholder="Êñ∞Â¢û‰∫ãÈ†Ö..." onkeypress="handleInputKey(event, 'next-week-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('next-week-list', 'input-next')">Ôºã</button>
                </div>
            </div>
        </div>

        <div class="column" id="col-long-term">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-long">üöÄ Èï∑ÊúüË¶èÂäÉ</span></div>
            <div class="note-list" id="long-term-list"></div>
            <div class="review-zone">
                <div class="review-header">ÂØ©Ê†∏ / Êö´‰∏ÄÊÆµËêΩ</div>
                <div class="note-list review-list" id="review-long"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-long" placeholder="Êñ∞Â¢û‰∫ãÈ†Ö..." onkeypress="handleInputKey(event, 'long-term-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('long-term-list', 'input-long')">Ôºã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================================================
        // ‚ñº Ë®≠ÂÆöÂçÄÂüüÔºöÂ∑≤ÁÇ∫ÊÇ®‰øÆÂæ©Ê†ºÂºè ‚ñº
        // ======================================================
        
        // ‰Ω†ÁöÑÈáëÈë∞ÈÖçÁΩÆ (Âæû‰Ω†Ë≤ºÁöÑ‰ª£Á¢º‰∏≠ÊèêÂèñ‰∏¶‰øÆÊ≠£ÁÇ∫ Compat Ê†ºÂºè)
        const firebaseConfig = {
          apiKey: "AIzaSyCZB-kPCA0zQ3yIuYjeYrQDWflWlBLsgw0",
          authDomain: "worktable-6d1bb.firebaseapp.com",
          databaseURL: "https://worktable-6d1bb-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "worktable-6d1bb",
          storageBucket: "worktable-6d1bb.firebasestorage.app",
          messagingSenderId: "615931449902",
          appId: "1:615931449902:web:112d9e17071456c32945bf"
        };

        // ======================================================
        // ‚ñ≤ Ë®≠ÂÆöÁµêÊùü ‚ñ≤
        // ======================================================

        let db;
        let dbRef;
        let isConnected = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (!firebaseConfig.apiKey) {
                alert('‚ö†Ô∏è Â∞öÊú™Ë®≠ÂÆö Firebase ConfigÔºÅ');
                return;
            }

            // ÂàùÂßãÂåñ Firebase (‰ΩøÁî®ÂÖ®ÂüüËÆäÊï∏ÊñπÂºè)
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                dbRef = db.ref('workBoardData'); // Ë≥áÊñôÂ∫´ÁØÄÈªû

                // Áõ£ËÅΩÈÄ£Á∑öÁãÄÊÖã
                const connectedRef = db.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        document.getElementById('status-dot').style.backgroundColor = '#30d158';
                        document.getElementById('status-text').innerText = 'Â∑≤ÈÄ£Á∑öÂêåÊ≠•‰∏≠';
                        isConnected = true;
                    } else {
                        document.getElementById('status-dot').style.backgroundColor = '#ff453a';
                        document.getElementById('status-text').innerText = 'Èõ¢Á∑ö (Á≠âÂæÖÈÄ£Á∑ö)';
                        isConnected = false;
                    }
                });

                // Áõ£ËÅΩË≥áÊñôËÆäÊõ¥
                dbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        renderBoard(data);
                    } else {
                        // Ëã•ÊòØÊñ∞Ë≥áÊñôÂ∫´ÔºåÂàùÂßãÂåñÁ©∫Ë≥áÊñô
                        saveDataToCloud(); 
                    }
                });

            } catch (error) {
                console.error("Firebase ÂàùÂßãÂåñÂ§±Êïó:", error);
                alert("Firebase ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÊ™¢Êü• Console ÈåØË™§Ë®äÊÅØ");
            }

            // Á∂ÅÂÆöÊ®ôÈ°åÁ∑®ËºØ‰∫ã‰ª∂
            document.querySelectorAll('.list-title').forEach(el => {
                el.addEventListener('input', debounceSave);
            });

            setupDragAndDrop();
        });

        // --- Áï´Èù¢Ê∏≤Êüì ---
        function renderBoard(data) {
            const map = {
                'urgent-list': data.urgent,
                'next-week-list': data.nextWeek,
                'long-term-list': data.longTerm,
                'review-urgent': data.reviewUrgent,
                'review-next': data.reviewNext,
                'review-long': data.reviewLong
            };
            
            const activeEl = document.activeElement;
            const isEditing = activeEl && activeEl.classList.contains('note-content');
            
            if(!isEditing) {
                for (const [listId, notes] of Object.entries(map)) {
                    const list = document.getElementById(listId);
                    list.innerHTML = '';
                    if (notes) {
                        notes.forEach(noteData => {
                            list.appendChild(createNoteElement(noteData.text, noteData.id));
                        });
                    }
                }
                if(data.titles) {
                    document.getElementById('title-urgent').innerText = data.titles.urgent || 'üî• Ê•µÈáçË¶Å / Êà™Á®øËøë';
                    document.getElementById('title-next').innerText = data.titles.nextWeek || 'üìÖ ‰∏ãÂë®ÈáçË¶Å‰∫ãÂãô';
                    document.getElementById('title-long').innerText = data.titles.longTerm || 'üöÄ Èï∑ÊúüË¶èÂäÉ';
                }
            }
        }

        // --- Ë≥áÊñôÊìç‰Ωú ---
        function createNoteElement(text = '', id = null) {
            const note = document.createElement('div');
            note.classList.add('note');
            note.setAttribute('draggable', 'true');
            note.id = id || 'note-' + Date.now();

            const content = document.createElement('div');
            content.classList.add('note-content');
            content.contentEditable = 'true';
            content.innerText = text;
            content.addEventListener('input', debounceSave);

            const delBtn = document.createElement('div');
            delBtn.classList.add('delete-btn');
            delBtn.innerHTML = '‚úï';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) {
                    note.remove();
                    saveDataToCloud();
                }
            };

            note.appendChild(content);
            note.appendChild(delBtn);

            note.addEventListener('dragstart', () => { note.classList.add('dragging'); });
            note.addEventListener('dragend', () => {
                note.classList.remove('dragging');
                saveDataToCloud(); 
            });

            return note;
        }

        function addCardFromInput(listId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;
            
            const list = document.getElementById(listId);
            list.appendChild(createNoteElement(text));
            list.scrollTop = list.scrollHeight;
            input.value = '';
            input.focus();
            
            saveDataToCloud();
        }

        function handleInputKey(event, listId, inputElement) {
            if (event.key === 'Enter') addCardFromInput(listId, inputElement.id);
        }

        // --- Ê†∏ÂøÉÂêåÊ≠•ÈÇèËºØ ---
        function saveDataToCloud() {
            if (!dbRef) return;

            const data = {
                urgent: getListContent('urgent-list'),
                nextWeek: getListContent('next-week-list'),
                longTerm: getListContent('long-term-list'),
                reviewUrgent: getListContent('review-urgent'),
                reviewNext: getListContent('review-next'),
                reviewLong: getListContent('review-long'),
                titles: {
                    urgent: document.getElementById('title-urgent').innerText,
                    nextWeek: document.getElementById('title-next').innerText,
                    longTerm: document.getElementById('title-long').innerText
                },
                lastUpdated: Date.now()
            };

            dbRef.set(data).catch(err => {
                console.error("ÂêåÊ≠•Â§±Êïó", err);
                document.getElementById('status-text').innerText = 'ÂêåÊ≠•Â§±Êïó!';
            });
        }

        function getListContent(listId) {
            const list = document.getElementById(listId);
            return [...list.querySelectorAll('.note')].map(note => ({
                id: note.id,
                text: note.querySelector('.note-content').innerText
            }));
        }

        let saveTimer;
        function debounceSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveDataToCloud, 800);
        }

        // --- ÊãñÊîæË®≠ÂÆö ---
        function setupDragAndDrop() {
            const allLists = document.querySelectorAll('.note-list');
            allLists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if(!draggable) return;
                    if (afterElement == null) {
                        list.appendChild(draggable);
                    } else {
                        list.insertBefore(draggable, afterElement);
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.note:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

    </script>
</body>
</html>