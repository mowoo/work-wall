<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯å·¥ä½œç‰† (v5.2)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #f5f5f7;
            --glass-bg: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            /* ä¸»é¡Œè‰² */
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --accent-green: #30d158;
            --accent-archive: #78909c; 
            --accent-inbox: #bf5af2; /* æ–°å¢ï¼šæ”¶é›†ç®±ç´«è‰² */

            --card-bg: rgba(60, 60, 65, 0.7);
            
            /* å¯©æ ¸å€æš—è‰²èƒŒæ™¯ */
            --dark-red-bg: rgba(70, 20, 20, 0.9);
            --dark-red-border: #6e2525;
            --dark-orange-bg: rgba(70, 40, 10, 0.9);
            --dark-orange-border: #7a4210;
            --dark-green-bg: rgba(20, 55, 25, 0.9);
            --dark-green-border: #1e5224;
            --dark-archive-bg: rgba(40, 50, 55, 0.9);
            --dark-archive-border: #455a64;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, rgba(50, 50, 60, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(20, 20, 25, 0.5) 0px, transparent 50%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Toolbar --- */
        .toolbar {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; opacity: 0.9; }

        .connection-status {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #888;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ff453a; transition: background-color 0.3s; }

        /* --- NEW: Inbox Section (æ”¶é›†ç®±) --- */
        .inbox-section {
            flex-shrink: 0;
            margin: 15px 20px 0 20px;
            padding: 10px;
            background: rgba(191, 90, 242, 0.1); /* ç´«è‰²èƒŒæ™¯æ·¡åŒ– */
            border: 1px dashed var(--accent-inbox);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 80px; /* å›ºå®šé«˜åº¦ */
        }

        .inbox-header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 120px;
            border-right: 1px solid rgba(255,255,255,0.1);
            padding-right: 15px;
        }

        .inbox-title { color: var(--accent-inbox); font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 5px; }
        
        .inbox-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px 10px;
            color: white;
            font-size: 0.85rem;
            outline: none;
            width: 100%;
            margin-top: 5px;
        }
        .inbox-input:focus { border-color: var(--accent-inbox); }

        /* æ©«å‘åˆ—è¡¨è¨­å®š */
        .inbox-list {
            flex-grow: 1;
            display: flex;
            flex-direction: row; /* æ©«å‘æ’åˆ— */
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            height: 100%;
            align-items: center;
            padding-right: 10px;
            scrollbar-width: thin;
        }
        
        /* æ”¶é›†ç®±å…§çš„å¡ç‰‡æ¨£å¼å¾®èª¿ */
        .inbox-list .note {
            min-width: 200px;
            max-width: 200px;
            height: auto;
            margin-bottom: 0; /* ç§»é™¤åº•éƒ¨é–“è· */
            flex-shrink: 0;
            background-color: rgba(60, 60, 65, 0.9);
            border: 1px solid var(--accent-inbox);
        }

        /* --- Board Area --- */
        .board {
            flex-grow: 1;
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        /* --- Columns --- */
        .column {
            flex: 0 0 320px;
            max-width: 320px;
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: transform 0.2s;
            overflow: hidden; 
        }

        .column-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        
        #col-urgent { border-top: 3px solid var(--accent-red); }
        #col-urgent .column-header { color: var(--accent-red); background: linear-gradient(to bottom, rgba(255, 69, 58, 0.1), transparent); }

        #col-next-week { border-top: 3px solid var(--accent-orange); }
        #col-next-week .column-header { color: var(--accent-orange); background: linear-gradient(to bottom, rgba(255, 159, 10, 0.1), transparent); }

        #col-long-term { border-top: 3px solid var(--accent-green); }
        #col-long-term .column-header { color: var(--accent-green); background: linear-gradient(to bottom, rgba(48, 209, 88, 0.1), transparent); }

        #col-archive { border-top: 3px solid var(--accent-archive); }
        #col-archive .column-header { color: var(--accent-archive); background: linear-gradient(to bottom, rgba(120, 144, 156, 0.1), transparent); }

        .note-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 100px;
            scrollbar-width: thin;
        }
        
        .review-zone {
            flex-shrink: 0;
            min-height: 100px;
            max-height: 40%;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid rgba(255, 255, 255, 0.1); 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .review-header {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.03);
            font-weight: bold;
        }
        .review-header::before { content: ''; display: block; width: 6px; height: 6px; border-radius: 50%; background-color: rgba(255,255,255,0.3); }

        .review-list { padding: 8px 12px; overflow-y: auto; flex-grow: 1; min-height: 50px; scrollbar-width: thin; }

        /* --- Cards --- */
        .note {
            background-color: var(--card-bg);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: grab;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            animation: fadeIn 0.3s ease;
        }
        .note:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); border-color: rgba(255, 255, 255, 0.2); z-index: 10; }

        /* Review Zone Colors */
        #review-urgent .note { background-color: var(--dark-red-bg); border-color: var(--dark-red-border); color: #ffcccc; }
        #review-next .note { background-color: var(--dark-orange-bg); border-color: var(--dark-orange-border); color: #ffeeba; }
        #review-long .note { background-color: var(--dark-green-bg); border-color: var(--dark-green-border); color: #d1e7dd; }
        #review-archive .note { background-color: var(--dark-archive-bg); border-color: var(--dark-archive-border); color: #cfd8dc; }

        .delete-btn {
            position: absolute;
            top: 6px; right: 6px; width: 20px; height: 20px;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            color: #888; cursor: pointer; opacity: 0; transition: all 0.2s; font-size: 14px;
        }
        .note:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: rgba(255, 69, 58, 0.2); color: var(--accent-red); }
        .dragging { opacity: 0.4; transform: scale(0.95); }

        /* Footer */
        .list-footer {
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.25);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            flex-shrink: 0;
        }
        .add-card-wrapper { display: flex; gap: 8px; }
        .new-card-input {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px; padding: 8px 10px; color: white; font-size: 0.9rem; outline: none; transition: border-color 0.2s;
        }
        .new-card-input:focus { border-color: rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); }
        .mini-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); border-radius: 6px; cursor: pointer; padding: 0 10px; }
        .mini-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 600px) {
            .board { flex-direction: column; overflow-y: auto; }
            .column { flex: none; max-width: 100%; margin-bottom: 20px; max-height: none; }
            .review-zone { max-height: none; min-height: 120px; }
            .inbox-section { flex-direction: column; height: auto; align-items: stretch; }
            .inbox-header { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 10px; }
            .inbox-list { min-height: 80px; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div style="display:flex; align-items:center;">
            <h1>é›²ç«¯å·¥ä½œç‰†</h1>
        </div>
        <div class="connection-status">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">é€£æ¥ä¸­...</span>
        </div>
    </div>

    <div class="inbox-section">
        <div class="inbox-header">
            <div class="inbox-title">ğŸ“¥ æ”¶é›†ç®± / æš«æ”¾</div>
            <input type="text" class="inbox-input" id="input-inbox" placeholder="è¼¸å…¥ä¸¦æŒ‰ Enter..." onkeypress="handleInputKey(event, 'inbox-list', this)">
        </div>
        <div class="note-list inbox-list" id="inbox-list"></div>
    </div>

    <div class="board">
        <div class="column" id="col-urgent">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-urgent">ğŸ”¥ æ¥µé‡è¦ / æˆªç¨¿è¿‘</span></div>
            <div class="note-list" id="urgent-list"></div>
            <div class="review-zone">
                <div class="review-header">å¯©æ ¸ / æš«ä¸€æ®µè½</div>
                <div class="note-list review-list" id="review-urgent"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-urgent" placeholder="æ–°å¢äº‹é …..." onkeypress="handleInputKey(event, 'urgent-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('urgent-list', 'input-urgent')">ï¼‹</button>
                </div>
            </div>
        </div>

        <div class="column" id="col-next-week">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-next">ğŸ“… ä¸‹å‘¨é‡è¦äº‹å‹™</span></div>
            <div class="note-list" id="next-week-list"></div>
            <div class="review-zone">
                <div class="review-header">å¯©æ ¸ / æš«ä¸€æ®µè½</div>
                <div class="note-list review-list" id="review-next"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-next" placeholder="æ–°å¢äº‹é …..." onkeypress="handleInputKey(event, 'next-week-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('next-week-list', 'input-next')">ï¼‹</button>
                </div>
            </div>
        </div>

        <div class="column" id="col-long-term">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-long">ğŸš€ é•·æœŸè¦åŠƒ</span></div>
            <div class="note-list" id="long-term-list"></div>
            <div class="review-zone">
                <div class="review-header">å¯©æ ¸ / æš«ä¸€æ®µè½</div>
                <div class="note-list review-list" id="review-long"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-long" placeholder="æ–°å¢äº‹é …..." onkeypress="handleInputKey(event, 'long-term-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('long-term-list', 'input-long')">ï¼‹</button>
                </div>
            </div>
        </div>

        <div class="column" id="col-archive">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-archive">ğŸ“¦ å°å­˜å€ / å·²å®Œæˆ</span></div>
            <div class="note-list" id="archive-list"></div>
            <div class="review-zone">
                <div class="review-header">æ­·å²æ­¸æª”</div>
                <div class="note-list review-list" id="review-archive"></div>
            </div>
            <div class="list-footer">
                <div class="add-card-wrapper">
                    <input type="text" class="new-card-input" id="input-archive" placeholder="æ–°å¢äº‹é …..." onkeypress="handleInputKey(event, 'archive-list', this)">
                    <button class="mini-btn" onclick="addCardFromInput('archive-list', 'input-archive')">ï¼‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================================================
        // â–¼ è¨­å®šå€åŸŸï¼šè«‹åœ¨æ­¤è²¼å›ä½ çš„ Firebase Config â–¼
        // ======================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCZB-kPCA0zQ3yIuYjeYrQDWflWlBLsgw0",
            authDomain: "worktable-6d1bb.firebaseapp.com",
            databaseURL: "https://worktable-6d1bb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "worktable-6d1bb",
            storageBucket: "worktable-6d1bb.firebasestorage.app",
            messagingSenderId: "615931449902",
            appId: "1:615931449902:web:112d9e17071456c32945bf"
        };

        // ======================================================
        // â–² è¨­å®šçµæŸ â–²
        // ======================================================

        let db;
        let dbRef;
        let isConnected = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (!firebaseConfig.apiKey) {
                alert('âš ï¸ è«‹è¨˜å¾—åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å›ä½ çš„ Firebase Configï¼');
                return;
            }

            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                dbRef = db.ref('workBoardData');

                const connectedRef = db.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        document.getElementById('status-dot').style.backgroundColor = '#30d158';
                        document.getElementById('status-text').innerText = 'å·²é€£ç·šåŒæ­¥ä¸­';
                        isConnected = true;
                    } else {
                        document.getElementById('status-dot').style.backgroundColor = '#ff453a';
                        document.getElementById('status-text').innerText = 'é›¢ç·š (ç­‰å¾…é€£ç·š)';
                        isConnected = false;
                    }
                });

                dbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) renderBoard(data);
                    else saveDataToCloud();
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                alert("Firebase é€£ç·šå¤±æ•—");
            }

            document.querySelectorAll('.list-title').forEach(el => {
                el.addEventListener('input', debounceSave);
            });

            setupDragAndDrop();
        });

        function renderBoard(data) {
            const map = {
                'inbox-list': data.inbox, // New Inbox
                'urgent-list': data.urgent,
                'next-week-list': data.nextWeek,
                'long-term-list': data.longTerm,
                'archive-list': data.archive,
                
                'review-urgent': data.reviewUrgent,
                'review-next': data.reviewNext,
                'review-long': data.reviewLong,
                'review-archive': data.reviewArchive
            };
            
            const activeEl = document.activeElement;
            const isEditing = activeEl && activeEl.classList.contains('note-content');
            
            if(!isEditing) {
                for (const [listId, notes] of Object.entries(map)) {
                    const list = document.getElementById(listId);
                    if(list) {
                        list.innerHTML = '';
                        if (notes) {
                            notes.forEach(noteData => {
                                list.appendChild(createNoteElement(noteData.text, noteData.id));
                            });
                        }
                    }
                }
                if(data.titles) {
                    document.getElementById('title-urgent').innerText = data.titles.urgent || 'ğŸ”¥ æ¥µé‡è¦ / æˆªç¨¿è¿‘';
                    document.getElementById('title-next').innerText = data.titles.nextWeek || 'ğŸ“… ä¸‹å‘¨é‡è¦äº‹å‹™';
                    document.getElementById('title-long').innerText = data.titles.longTerm || 'ğŸš€ é•·æœŸè¦åŠƒ';
                    document.getElementById('title-archive').innerText = data.titles.archive || 'ğŸ“¦ å°å­˜å€ / å·²å®Œæˆ';
                }
            }
        }

        function createNoteElement(text = '', id = null) {
            const note = document.createElement('div');
            note.classList.add('note');
            note.setAttribute('draggable', 'true');
            note.id = id || 'note-' + Date.now();

            const content = document.createElement('div');
            content.classList.add('note-content');
            content.contentEditable = 'true';
            content.innerText = text;
            content.addEventListener('input', debounceSave);

            const delBtn = document.createElement('div');
            delBtn.classList.add('delete-btn');
            delBtn.innerHTML = 'âœ•';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ')) {
                    note.remove();
                    saveDataToCloud();
                }
            };

            note.appendChild(content);
            note.appendChild(delBtn);

            note.addEventListener('dragstart', () => { note.classList.add('dragging'); });
            note.addEventListener('dragend', () => {
                note.classList.remove('dragging');
                saveDataToCloud(); 
            });

            return note;
        }

        function addCardFromInput(listId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;
            
            const list = document.getElementById(listId);
            list.appendChild(createNoteElement(text));
            // å¦‚æœæ˜¯ inbox (æ©«å‘)ï¼Œæ²å‹•åˆ°æœ€å³é‚Šï¼›å¦å‰‡æ²å‹•åˆ°æœ€ä¸‹æ–¹
            if(listId === 'inbox-list') {
                 list.scrollLeft = list.scrollWidth;
            } else {
                 list.scrollTop = list.scrollHeight;
            }
            
            input.value = '';
            input.focus();
            
            saveDataToCloud();
        }

        function handleInputKey(event, listId, inputElement) {
            if (event.key === 'Enter') addCardFromInput(listId, inputElement.id);
        }

        function saveDataToCloud() {
            if (!dbRef) return;

            const data = {
                inbox: getListContent('inbox-list'), // New
                urgent: getListContent('urgent-list'),
                nextWeek: getListContent('next-week-list'),
                longTerm: getListContent('long-term-list'),
                archive: getListContent('archive-list'),
                
                reviewUrgent: getListContent('review-urgent'),
                reviewNext: getListContent('review-next'),
                reviewLong: getListContent('review-long'),
                reviewArchive: getListContent('review-archive'),
                
                titles: {
                    urgent: document.getElementById('title-urgent').innerText,
                    nextWeek: document.getElementById('title-next').innerText,
                    longTerm: document.getElementById('title-long').innerText,
                    archive: document.getElementById('title-archive').innerText
                },
                lastUpdated: Date.now()
            };

            dbRef.set(data).catch(err => {
                console.error("åŒæ­¥å¤±æ•—", err);
                document.getElementById('status-text').innerText = 'åŒæ­¥å¤±æ•—!';
            });
        }

        function getListContent(listId) {
            const list = document.getElementById(listId);
            if (!list) return [];
            return [...list.querySelectorAll('.note')].map(note => ({
                id: note.id,
                text: note.querySelector('.note-content').innerText
            }));
        }

        let saveTimer;
        function debounceSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveDataToCloud, 800);
        }

        function setupDragAndDrop() {
            const allLists = document.querySelectorAll('.note-list');
            allLists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    
                    // åˆ¤æ–·æ˜¯æ©«å‘åˆ—è¡¨(inbox)é‚„æ˜¯ç›´å‘åˆ—è¡¨(column)
                    const isHorizontal = list.id === 'inbox-list';
                    const afterElement = getDragAfterElement(list, isHorizontal ? e.clientX : e.clientY, isHorizontal);
                    
                    const draggable = document.querySelector('.dragging');
                    if(!draggable) return;
                    if (afterElement == null) {
                        list.appendChild(draggable);
                    } else {
                        list.insertBefore(draggable, afterElement);
                    }
                });
            });
        }

        // æ”¯æ´æ©«å‘èˆ‡ç›´å‘çš„æ‹–æ›³è¨ˆç®—
        function getDragAfterElement(container, pos, isHorizontal) {
            const draggableElements = [...container.querySelectorAll('.note:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // å¦‚æœæ˜¯æ©«å‘ï¼Œè¨ˆç®— X è»¸ä¸­å¿ƒï¼›å¦‚æœæ˜¯ç›´å‘ï¼Œè¨ˆç®— Y è»¸ä¸­å¿ƒ
                const boxCenter = isHorizontal ? box.left + box.width / 2 : box.top + box.height / 2;
                const offset = pos - boxCenter;
                
                // é‚è¼¯ï¼šoffset < 0 ä»£è¡¨æ»‘é¼ åœ¨å…ƒç´ çš„å‰åŠéƒ¨/ä¸ŠåŠéƒ¨
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

    </script>
</body>
</html>
