<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÈõ≤Á´ØÂ∑•‰ΩúÁâÜ (v7.1 Chrono Aurora)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="config.js"></script>

    <style>
        :root {
            --bg-color: #000000; --text-color: #f5f5f7;
            --glass-bg: rgba(28, 28, 30, 0.65); --glass-border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(60, 60, 65, 0.7);
            
            /* Colors */
            --accent-red: #ff453a; --accent-orange: #ff9f0a; --accent-green: #30d158;
            --accent-archive: #78909c; --accent-inbox: #bf5af2;
            
            /* Dark Mode Review Zones */
            --dark-red-bg: rgba(70, 20, 20, 0.9); --dark-red-border: #6e2525;
            --dark-orange-bg: rgba(70, 40, 10, 0.9); --dark-orange-border: #7a4210;
            --dark-green-bg: rgba(20, 55, 25, 0.9); --dark-green-border: #1e5224;
            --dark-archive-bg: rgba(40, 50, 55, 0.9); --dark-archive-border: #455a64;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(at 0% 0%, rgba(50, 50, 60, 0.5) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(20, 20, 25, 0.5) 0px, transparent 50%);
            color: var(--text-color); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: box-shadow 0.5s; /* For Alert Flashing */
        }

        /* Alert Flashing Animation */
        @keyframes flash-alert {
            0% { box-shadow: inset 0 0 0 0 transparent; }
            50% { box-shadow: inset 0 0 50px 20px rgba(255, 69, 58, 0.8); }
            100% { box-shadow: inset 0 0 0 0 transparent; }
        }
        body.time-up { animation: flash-alert 1s infinite; }

        /* Toolbar */
        .toolbar { padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
        h1 { margin: 0; font-size: 1rem; font-weight: 600; opacity: 0.9; }
        .connection-status { font-size: 0.75rem; display: flex; align-items: center; gap: 6px; color: #888; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #aaa; transition: background-color 0.3s; }
        
        /* --- Top Container --- */
        .top-container {
            flex-shrink: 0; display: flex; gap: 15px; padding: 15px 20px 5px 20px; height: 110px; /* Height increased for bigger clock */
        }

        /* Inbox Section */
        .inbox-section {
            flex-grow: 1; background: rgba(191, 90, 242, 0.1); border: 1px dashed var(--accent-inbox); border-radius: 12px; 
            display: flex; align-items: center; gap: 10px; padding: 8px 15px; min-width: 0;
        }
        .inbox-header { display: flex; flex-direction: column; justify-content: center; min-width: 100px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 10px; }
        .inbox-title { color: var(--accent-inbox); font-weight: bold; font-size: 0.9rem; }
        .inbox-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; padding: 4px 8px; color: white; font-size: 0.85rem; outline: none; width: 100%; margin-top: 4px; }
        .inbox-list { flex-grow: 1; display: flex; flex-direction: row; gap: 8px; overflow-x: auto; overflow-y: hidden; height: 100%; align-items: center; padding-right: 5px; scrollbar-width: thin; }
        .inbox-list .note { min-width: 200px; max-width: 200px; margin-bottom: 0; flex-shrink: 0; }

        /* --- TIMER SECTION (New Design) --- */
        .timer-section {
            flex-shrink: 0; width: 280px; /* Slightly wider */
            /* Á•ûÁßòÊöóËâ≤Êº∏Â±§ÔºöÊ∑±Ëóç -> ÂçàÂ§úÁ¥´ -> Â¢®Á∂† */
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 12px 15px;
            position: relative; overflow: hidden;
        }
        /* Â¢ûÂä†‰∏ÄÈªûÊµÅÂãïÂÖâÂΩ± (Optional aesthetic) */
        .timer-section::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }

        /* Real-time Clock (Huge) */
        .clock-display {
            font-size: 2.4rem; /* Â≠óÁ¥öÂä†Â§ß */
            font-weight: 700;
            color: rgba(255,255,255,0.95);
            text-align: center;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            text-shadow: 0 0 15px rgba(100, 210, 255, 0.4); /* ÂæÆÂÖâ */
            font-family: 'Segoe UI', Roboto, monospace;
            margin-top: 2px;
        }
        .clock-date {
            font-size: 0.75rem; color: rgba(255,255,255,0.5); text-align: center; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;
        }

        /* Pomodoro Controls */
        .pomodoro-container {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .pomo-time {
            font-size: 1.2rem; font-weight: bold; color: #ddd; font-variant-numeric: tabular-nums;
            min-width: 60px; text-align: center;
        }
        .pomo-time.running { color: var(--accent-orange); text-shadow: 0 0 5px rgba(255, 159, 10, 0.5); }

        .pomo-controls { display: flex; gap: 4px; align-items: center; }
        
        .pomo-btn {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 24px; height: 24px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; font-size: 0.7rem;
        }
        .pomo-btn:hover { background: rgba(255,255,255,0.25); }
        .pomo-btn.main-action { width: 28px; height: 28px; background: rgba(255, 255, 255, 0.15); font-size: 0.9rem; }
        .pomo-btn.main-action:hover { background: rgba(48, 209, 88, 0.4); }

        /* Board & Columns */
        .board { flex-grow: 1; display: flex; gap: 12px; overflow-x: auto; padding: 15px; height: 100%; box-sizing: border-box; }
        .column { flex: 0 0 300px; max-width: 300px; background-color: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; display: flex; flex-direction: column; max-height: 100%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); overflow: hidden; }
        .column-header { padding: 10px 12px; font-weight: 600; font-size: 0.9rem; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #col-urgent { border-top: 3px solid var(--accent-red); } #col-urgent .column-header { color: var(--accent-red); background: linear-gradient(to bottom, rgba(255, 69, 58, 0.1), transparent); }
        #col-next-week { border-top: 3px solid var(--accent-orange); } #col-next-week .column-header { color: var(--accent-orange); background: linear-gradient(to bottom, rgba(255, 159, 10, 0.1), transparent); }
        #col-long-term { border-top: 3px solid var(--accent-green); } #col-long-term .column-header { color: var(--accent-green); background: linear-gradient(to bottom, rgba(48, 209, 88, 0.1), transparent); }
        #col-archive { border-top: 3px solid var(--accent-archive); } #col-archive .column-header { color: var(--accent-archive); background: linear-gradient(to bottom, rgba(120, 144, 156, 0.1), transparent); }
        .note-list { flex-grow: 1; overflow-y: auto; padding: 8px; min-height: 80px; scrollbar-width: thin; }
        .review-zone { flex-shrink: 0; min-height: 80px; max-height: 40%; display: flex; flex-direction: column; background: rgba(0, 0, 0, 0.3); border-top: 2px solid rgba(255, 255, 255, 0.1); }
        .review-header { font-size: 0.7rem; color: rgba(255,255,255,0.5); padding: 6px 10px; font-weight: bold; background: rgba(255,255,255,0.03); }
        .review-list { padding: 6px 10px; overflow-y: auto; flex-grow: 1; }

        /* Focus Slot */
        .focus-slot { flex-shrink: 0; margin: 8px; border: 1px dashed rgba(255, 69, 58, 0.3); border-radius: 6px; background: rgba(255, 69, 58, 0.05); display: flex; flex-direction: column; transition: all 0.2s; height: auto; }
        .focus-slot:empty { min-height: 60px; justify-content: center; align-items: center; }
        .focus-slot:empty::before { content: 'Doing (ÊãñÊõ≥Ëá≥Ê≠§)'; color: rgba(255, 69, 58, 0.5); font-size: 0.8rem; pointer-events: none; }
        .focus-slot:not(:empty) { border: none; background: transparent; min-height: 0; }
        .focus-slot .note { background-color: var(--accent-red) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4); margin-bottom: 0; }
        .focus-slot .note .note-content { color: white; font-weight: 500; }
        .focus-slot .note .note-meta { border-top-color: rgba(255,255,255,0.3); color: rgba(255,255,255,0.9); }
        .focus-slot .note .link-btn { color: white; text-decoration: underline; }
        .focus-slot .note .tool-icon { color: rgba(255,255,255,0.8); }
        .focus-slot .note .tool-icon:hover { background-color: rgba(255,255,255,0.3); color: white; }
        .focus-slot .note .date-badge { background: rgba(255,255,255,0.25); color: white; }

        /* Note Styles */
        .note { background-color: var(--card-bg); padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: grab; position: relative; transition: all 0.2s ease; animation: fadeIn 0.3s ease; display: flex; flex-direction: column; gap: 4px; border-left: 3px solid transparent; }
        .note:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.4); border-color: rgba(255, 255, 255, 0.2); z-index: 10; } .note:active { cursor: grabbing; }
        .note-content { outline: none; word-break: break-word; font-size: 0.9rem; line-height: 1.4; padding-right: 15px; }
        .tools { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; background: rgba(0,0,0,0.5); border-radius: 4px; padding: 2px; } .note:hover .tools { opacity: 1; }
        .tool-icon { cursor: pointer; width: 18px; height: 18px; text-align: center; line-height: 18px; border-radius: 3px; font-size: 12px; color: #ddd; }
        .note-meta { display: none; align-items: center; justify-content: flex-start; gap: 8px; font-size: 0.75rem; color: #aaa; margin-top: 4px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 4px; } .note-meta.has-content { display: flex; }
        .date-badge { background: rgba(255,255,255,0.1); padding: 1px 5px; border-radius: 3px; display: none; font-size: 0.7rem; } .date-badge.active { display: inline-block; } .date-badge.urgent { background: rgba(255, 159, 10, 0.3); color: #ffbc5e; } .date-badge.overdue { background: rgba(255, 69, 58, 0.3); color: #ff8a84; }
        .link-btn { text-decoration: none; color: #64d2ff; cursor: pointer; display: none; align-items: center; gap: 4px; } .link-btn.active { display: flex; }
        .settings-panel { display: none; background: rgba(0,0,0,0.9); padding: 8px; border-radius: 4px; margin-top: 4px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.2); z-index: 20; position: relative;} .settings-panel.open { display: block; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        input[type="date"] { background: rgba(255,255,255,0.1); border: none; color: white; padding: 2px; border-radius: 3px; }
        .color-dots { display: flex; gap: 4px; } .color-dot { width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 1px solid transparent; } .color-dot.selected { border-color: white; }
        #review-urgent .note { background-color: var(--dark-red-bg); border-color: var(--dark-red-border); } #review-next .note { background-color: var(--dark-orange-bg); border-color: var(--dark-orange-border); } #review-long .note { background-color: var(--dark-green-bg); border-color: var(--dark-green-border); } #review-archive .note { background-color: var(--dark-archive-bg); border-color: var(--dark-archive-border); }
        .list-footer { padding: 8px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.25); flex-shrink: 0; } .new-card-input { flex-grow: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; padding: 6px 8px; color: white; outline: none; font-size: 0.85rem;} .mini-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); border-radius: 6px; cursor: pointer; padding: 0 8px; margin-left: 6px;}
        
        @media (max-width: 600px) { .top-container { flex-direction: column; height: auto; } .timer-section { width: 100%; margin-bottom: 10px; } }
    </style>
</head>
<body>

    <div class="toolbar">
        <h1>Èõ≤Á´ØÂ∑•‰ΩúÁâÜ <span style="font-size:0.7em; opacity:0.6; font-weight:normal;" id="version-tag">v7.1 Aurora</span></h1>
        <div class="connection-status"><div id="status-dot" class="status-dot"></div><span id="status-text">ÂàùÂßãÂåñ...</span></div>
    </div>

    <div class="top-container">
        <div class="inbox-section">
            <div class="inbox-header">
                <div class="inbox-title">üì• Êî∂ÈõÜÁÆ±</div>
                <input type="text" class="inbox-input" id="input-inbox" placeholder="Enter Êñ∞Â¢û..." onkeypress="handleInputKey(event, 'inbox-list', this)">
            </div>
            <div class="note-list inbox-list" id="inbox-list"></div>
        </div>

        <div class="timer-section">
            <div>
                <div class="clock-display" id="real-clock">--:--:--</div>
                <div class="clock-date" id="real-date">LOADING...</div>
            </div>
            <div class="pomodoro-container">
                <div class="pomo-controls">
                    <button class="pomo-btn" onclick="adjustTime(-5)" title="-5ÂàÜÈêò">-5</button>
                </div>
                <div class="pomo-time" id="pomo-display">25:00</div>
                <div class="pomo-controls">
                    <button class="pomo-btn" onclick="adjustTime(5)" title="+5ÂàÜÈêò">+5</button>
                    <button class="pomo-btn main-action" onclick="toggleTimer()" title="ÈñãÂßã/Êö´ÂÅú">‚èØ</button>
                    <button class="pomo-btn" onclick="resetTimer()" title="ÈáçÁΩÆ">‚Ü∫</button>
                </div>
            </div>
        </div>
    </div>

    <div class="board">
        <div class="column" id="col-urgent">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-urgent">üî• Ê•µÈáçË¶Å</span></div>
            <div class="note-list focus-slot" id="focus-slot"></div>
            <div class="note-list" id="urgent-list"></div>
            <div class="review-zone"><div class="review-header">Êö´Êîæ / ÂØ©Ê†∏</div><div class="note-list review-list" id="review-urgent"></div></div>
            <div class="list-footer"><div style="display:flex"><input type="text" class="new-card-input" id="input-urgent" placeholder="Êñ∞Â¢û..." onkeypress="handleInputKey(event, 'urgent-list', this)"><button class="mini-btn" onclick="addCardFromInput('urgent-list', 'input-urgent')">Ôºã</button></div></div>
        </div>
        <div class="column" id="col-next-week">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-next">üìÖ ‰∏ãÂë®‰∫ãÈ†Ö</span></div>
            <div class="note-list" id="next-week-list"></div>
            <div class="review-zone"><div class="review-header">Êö´Êîæ / ÂØ©Ê†∏</div><div class="note-list review-list" id="review-next"></div></div>
            <div class="list-footer"><div style="display:flex"><input type="text" class="new-card-input" id="input-next" placeholder="Êñ∞Â¢û..." onkeypress="handleInputKey(event, 'next-week-list', this)"><button class="mini-btn" onclick="addCardFromInput('next-week-list', 'input-next')">Ôºã</button></div></div>
        </div>
        <div class="column" id="col-long-term">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-long">üöÄ Èï∑ÊúüË¶èÂäÉ</span></div>
            <div class="note-list" id="long-term-list"></div>
            <div class="review-zone"><div class="review-header">Êö´Êîæ / Êö´‰∏ÄÊÆµËêΩ</div><div class="note-list review-list" id="review-long"></div></div>
            <div class="list-footer"><div style="display:flex"><input type="text" class="new-card-input" id="input-long" placeholder="Êñ∞Â¢û..." onkeypress="handleInputKey(event, 'long-term-list', this)"><button class="mini-btn" onclick="addCardFromInput('long-term-list', 'input-long')">Ôºã</button></div></div>
        </div>
        <div class="column" id="col-archive">
            <div class="column-header"><span contenteditable="true" class="list-title" id="title-archive">üì¶ Â∑≤ÂÆåÊàê</span></div>
            <div class="note-list" id="archive-list"></div>
            <div class="review-zone"><div class="review-header">Ê≠∑Âè≤Ê≠∏Ê™î</div><div class="note-list review-list" id="review-archive"></div></div>
            <div class="list-footer"><div style="display:flex"><input type="text" class="new-card-input" id="input-archive" placeholder="Êñ∞Â¢û..." onkeypress="handleInputKey(event, 'archive-list', this)"><button class="mini-btn" onclick="addCardFromInput('archive-list', 'input-archive')">Ôºã</button></div></div>
        </div>
    </div>

    <script>
        let db; let dbRef; let isConnected = false; let isDemoMode = false;
        let timerInterval; let timeLeft = 25 * 60; let isTimerRunning = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebaseConfig === 'undefined' || !firebaseConfig.apiKey) { initDemoMode(); } else { initFirebase(); }
            document.querySelectorAll('.list-title').forEach(el => el.addEventListener('input', debounceSave));
            setupDragAndDrop();
            startRealClock();
            updateTimerDisplay();
        });

        // --- Real-time Clock ---
        function startRealClock() {
            const update = () => {
                const now = new Date();
                // HH:MM:SS
                document.getElementById('real-clock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
                // Weekday Date
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                document.getElementById('real-date').innerText = now.toLocaleDateString('en-US', options);
            };
            setInterval(update, 1000);
            update();
        }

        // --- Pomodoro Timer Logic ---
        function toggleTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            } else {
                // Remove alert state if exists
                document.body.classList.remove('time-up');
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateTimerDisplay();
                    } else {
                        triggerAlarm();
                    }
                }, 1000);
            }
            updateTimerDisplay();
        }

        function adjustTime(minutes) {
            timeLeft += minutes * 60;
            if (timeLeft < 0) timeLeft = 0;
            updateTimerDisplay();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timeLeft = 25 * 60;
            document.body.classList.remove('time-up'); // Stop flashing
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = document.getElementById('pomo-display');
            display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (isTimerRunning) display.classList.add('running'); else display.classList.remove('running');
        }

        function triggerAlarm() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            updateTimerDisplay();
            
            // 1. Visual Alert: Flashing Background
            document.body.classList.add('time-up');
            
            // 2. Audio Alert: Generate Beep using Web Audio API (No external file needed)
            playBeep();
            
            // Auto-stop visual alert after 5 seconds
            setTimeout(() => { document.body.classList.remove('time-up'); }, 5000);
        }

        // Simple Beep Generator
        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5 tone
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            
            oscillator.start();
            // Beep pattern: Beep... Beep... Beep
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        // --- Firebase & Board Logic (Standard) ---
        function initDemoMode() { isDemoMode = true; document.getElementById('status-dot').style.backgroundColor = '#aaa'; document.getElementById('status-text').innerText = 'ÂÖ¨ÈñãÊºîÁ§∫Ê®°Âºè (ÁÑ°ÂÑ≤Â≠ò)'; }
        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig); db = firebase.database(); dbRef = db.ref('workBoardData');
                db.ref(".info/connected").on("value", (snap) => { document.getElementById('status-dot').style.backgroundColor = snap.val() ? '#30d158' : '#ff453a'; document.getElementById('status-text').innerText = snap.val() ? 'Â∑≤ÈÄ£Á∑ö (ÁßÅÊúâ)' : 'Èõ¢Á∑ö'; });
                dbRef.on('value', (snapshot) => { const data = snapshot.val(); if (data) renderBoard(data); else saveDataToCloud(); });
            } catch (error) { console.error("Firebase Error", error); initDemoMode(); }
        }
        function renderBoard(data) {
            const map = { 'inbox-list': data.inbox, 'focus-slot': data.focus, 'urgent-list': data.urgent, 'next-week-list': data.nextWeek, 'long-term-list': data.longTerm, 'archive-list': data.archive, 'review-urgent': data.reviewUrgent, 'review-next': data.reviewNext, 'review-long': data.reviewLong, 'review-archive': data.reviewArchive };
            const activeEl = document.activeElement; const isEditing = activeEl && (activeEl.classList.contains('note-content') || activeEl.tagName === 'INPUT');
            if(!isEditing) {
                for (const [listId, notes] of Object.entries(map)) {
                    const list = document.getElementById(listId);
                    if(list) { list.innerHTML = ''; if (notes) notes.forEach(n => list.appendChild(createNoteElement(n))); }
                }
                if(data.titles) { document.getElementById('title-urgent').innerText = data.titles.urgent; document.getElementById('title-next').innerText = data.titles.nextWeek; document.getElementById('title-long').innerText = data.titles.longTerm; document.getElementById('title-archive').innerText = data.titles.archive; }
            }
        }
        function saveDataToCloud() {
            if (isDemoMode) return;
            const focusList = document.getElementById('focus-slot'); const urgentList = document.getElementById('urgent-list');
            while (focusList.children.length > 1) { const oldNote = focusList.firstElementChild; urgentList.insertBefore(oldNote, urgentList.firstElementChild); }
            const data = { inbox: getListContent('inbox-list'), focus: getListContent('focus-slot'), urgent: getListContent('urgent-list'), nextWeek: getListContent('next-week-list'), longTerm: getListContent('long-term-list'), archive: getListContent('archive-list'), reviewUrgent: getListContent('review-urgent'), reviewNext: getListContent('review-next'), reviewLong: getListContent('review-long'), reviewArchive: getListContent('review-archive'), titles: { urgent: document.getElementById('title-urgent').innerText, nextWeek: document.getElementById('title-next').innerText, longTerm: document.getElementById('title-long').innerText, archive: document.getElementById('title-archive').innerText }, lastUpdated: Date.now() };
            if(dbRef) dbRef.set(data).catch(e => console.error(e));
        }
        function createNoteElement(data) {
            const noteData = (typeof data === 'string') ? { text: data, id: 'note-'+Date.now() } : data;
            const note = document.createElement('div'); note.classList.add('note'); note.setAttribute('draggable', 'true'); note.id = noteData.id;
            if (noteData.tagColor) note.style.borderLeftColor = noteData.tagColor;
            const content = document.createElement('div'); content.classList.add('note-content'); content.contentEditable = 'true'; content.innerText = noteData.text;
            const tools = document.createElement('div'); tools.classList.add('tools');
            const settingsBtn = document.createElement('div'); settingsBtn.classList.add('tool-icon'); settingsBtn.innerText = '‚öôÔ∏è'; settingsBtn.onclick = (e) => { e.stopPropagation(); toggleSettings(note); };
            const delBtn = document.createElement('div'); delBtn.classList.add('tool-icon', 'delete-icon'); delBtn.innerText = '‚úï'; delBtn.onclick = (e) => { e.stopPropagation(); if(confirm('Âà™Èô§Ôºü')) { note.remove(); saveDataToCloud(); } };
            tools.appendChild(settingsBtn); tools.appendChild(delBtn);
            const meta = document.createElement('div'); meta.classList.add('note-meta');
            const linkBtn = document.createElement('a'); linkBtn.classList.add('link-btn'); linkBtn.target = "_blank"; linkBtn.innerHTML = '<span>üîó</span>ÈÄ£Áµê'; meta.appendChild(linkBtn);
            const dateBadge = document.createElement('span'); dateBadge.classList.add('date-badge'); meta.appendChild(dateBadge);
            const checkMetaVisibility = () => { const hasLink = updateLinkButton(note, content.innerText); const hasDate = noteData.dueDate && noteData.dueDate !== ''; if(hasDate) updateDateDisplay(dateBadge, noteData.dueDate); if (hasLink || hasDate) meta.classList.add('has-content'); else meta.classList.remove('has-content'); };
            content.addEventListener('input', () => { checkMetaVisibility(); debounceSave(); }); setTimeout(() => checkMetaVisibility(), 0);
            const settingsPanel = document.createElement('div'); settingsPanel.classList.add('settings-panel');
            const dateRow = document.createElement('div'); dateRow.classList.add('settings-row');
            const dateInput = document.createElement('input'); dateInput.type = 'date'; if(noteData.dueDate) dateInput.value = noteData.dueDate; dateInput.addEventListener('change', () => { noteData.dueDate = dateInput.value; checkMetaVisibility(); saveDataToCloud(); }); dateRow.innerHTML = '<span>Âà∞ÊúüÊó•:</span>'; dateRow.appendChild(dateInput);
            const colorRow = document.createElement('div'); colorRow.classList.add('settings-row'); colorRow.innerHTML = '<span>Ê®ôÁ±§:</span>';
            const colorsDiv = document.createElement('div'); colorsDiv.classList.add('color-dots');
            const colors = ['#ff453a', '#0a84ff', '#30d158', '#ffd60a', '#bf5af2', 'transparent']; colors.forEach(c => { const dot = document.createElement('div'); dot.classList.add('color-dot'); dot.style.backgroundColor = c === 'transparent' ? '#333' : c; dot.onclick = () => { note.style.borderLeftColor = c; saveDataToCloud(); }; colorsDiv.appendChild(dot); }); colorRow.appendChild(colorsDiv);
            settingsPanel.appendChild(dateRow); settingsPanel.appendChild(colorRow);
            note.appendChild(tools); note.appendChild(content); note.appendChild(meta); note.appendChild(settingsPanel);
            note.addEventListener('dragstart', () => note.classList.add('dragging')); note.addEventListener('dragend', () => { note.classList.remove('dragging'); saveDataToCloud(); });
            return note;
        }
        function updateDateDisplay(badge, dateStr) {
            if (!dateStr) { badge.classList.remove('active'); return; }
            const due = new Date(dateStr); const now = new Date(); const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24)); 
            badge.classList.add('active'); badge.classList.remove('urgent', 'overdue');
            if (diffDays < 0) { badge.innerText = `ÈÄæÊúü ${Math.abs(diffDays)}Â§©`; badge.classList.add('overdue'); } else if (diffDays === 0) { badge.innerText = '‰ªäÂ§©'; badge.classList.add('urgent'); } else if (diffDays <= 2) { badge.innerText = `Ââ© ${diffDays}Â§©`; badge.classList.add('urgent'); } else { badge.innerText = `${dateStr.slice(5)}`; }
        }
        function updateLinkButton(note, text) { const linkBtn = note.querySelector('.link-btn'); const urlRegex = /(https?:\/\/[^\s]+)/g; const match = text.match(urlRegex); if (match) { linkBtn.href = match[0]; linkBtn.classList.add('active'); return true; } else { linkBtn.classList.remove('active'); return false; } }
        function toggleSettings(note) { const panel = note.querySelector('.settings-panel'); const isOpen = panel.classList.contains('open'); document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('open')); if (!isOpen) panel.classList.add('open'); }
        function addCardFromInput(listId, inputId) { const input = document.getElementById(inputId); const text = input.value.trim(); if (!text) return; const list = document.getElementById(listId); const newNoteData = { text: text, id: 'note-'+Date.now(), dueDate: '', tagColor: '' }; list.appendChild(createNoteElement(newNoteData)); if(listId === 'inbox-list') list.scrollLeft = list.scrollWidth; else list.scrollTop = list.scrollHeight; input.value = ''; input.focus(); saveDataToCloud(); }
        function handleInputKey(e, l, i) { if (e.key === 'Enter') addCardFromInput(l, i.id); }
        function getListContent(listId) { const list = document.getElementById(listId); if (!list) return []; return [...list.querySelectorAll('.note')].map(note => ({ id: note.id, text: note.querySelector('.note-content').innerText, tagColor: note.style.borderLeftColor || '', dueDate: note.querySelector('input[type="date"]').value || '' })); }
        let saveTimer; function debounceSave() { clearTimeout(saveTimer); saveTimer = setTimeout(saveDataToCloud, 800); }
        function setupDragAndDrop() { document.querySelectorAll('.note-list').forEach(list => { list.addEventListener('dragover', e => { e.preventDefault(); const isHorizontal = list.id === 'inbox-list'; const afterElement = getDragAfterElement(list, isHorizontal ? e.clientX : e.clientY, isHorizontal); const draggable = document.querySelector('.dragging'); if(draggable) { if (afterElement == null) list.appendChild(draggable); else list.insertBefore(draggable, afterElement); } }); }); }
        function getDragAfterElement(container, pos, isHorizontal) { const draggableElements = [...container.querySelectorAll('.note:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const boxCenter = isHorizontal ? box.left + box.width / 2 : box.top + box.height / 2; const offset = pos - boxCenter; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
    </script>
</body>
</html>
